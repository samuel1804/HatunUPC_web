@using HatunsolBE;
@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";



    var ListDespachos = (List<DespachoBE>)ViewBag.ListDespachos;

}


<head>

    <script src="~/Content/vendors/select2/dist/js/select2.full.min.js"></script>



    <script src="~/Content/vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="~/Content/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="~/Content/vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="~/Content/vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="~/Content/vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="~/Content/vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="~/Content/vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="~/Content/vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="~/Content/vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="~/Content/vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/Content/vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="~/Content/vendors/datatables.net-scroller/js/datatables.scroller.min.js"></script>
    <script src="~/Content/vendors/jszip/dist/jszip.min.js"></script>
    <script src="~/Content/vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="~/Content/vendors/pdfmake/build/vfs_fonts.js"></script>





    <style>
        td.editar {
            cursor: pointer;
        }

        td.eliminar {
            cursor: pointer;
        }

        td.link {
            cursor: pointer;
        }
    </style>
    <style type="text/css">
        .web_dialog_overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            background: #000000;
            opacity: .15;
            filter: alpha(opacity=15);
            -moz-opacity: .15;
            z-index: 101;
            display: none;
        }

        .web_dialog {
            display: none;
            position: fixed;
            width: 800px;
            height: 500px;
            top: 30%;
            left: 40%;
            margin-left: -190px;
            margin-top: -100px;
            background-color: #ffffff;
            border: 2px solid #336699;
            padding: 0px;
            z-index: 102;
            font-family: Verdana;
            font-size: 10pt;
        }

        .web_dialog_title {
            border-bottom: solid 2px #336699;
            background-color: #336699;
            padding: 4px;
            color: White;
            font-weight: bold;
        }

            .web_dialog_title a {
                color: White;
                text-decoration: none;
            }

        .align_right {
            text-align: right;
        }
    </style>


</head>


<div class="page-title">
    <div class="title_left">
        <h3>Despachos</h3>
    </div>
</div>
<div class="clearfix"></div>


<div class="col-md-12 col-sm-12 col-xs-12">
    <div class="x_panel">
        <div class="x_title">
            <h2>Generar Guía de Despacho</h2>
            <div class="nav panel_toolbox">
                <label>Nro de Guía</label>
                <input placeholder="Orden de Compra" type="text" value="0001" />

            </div>


            <div class="clearfix"></div>
        </div>

        <div class="x_content">

            <form id="frmdatos" method="post" action="" role="form" class="form-horizontal form-label-left">

                <div class="form-group">
                    <input type="hidden" id="IdOrden" name="IdOrden" />
                    <input type="hidden" id="TipoOrden" name="TipoOrden" />
                    <label class="control-label col-md-1 col-sm-1 col-xs-12" for="first-name">
                        DNI
                    </label>
                    <div class="col-md-4 col-sm-4 col-xs-12">
                        <input type="text" placeholder="Ingrese DNI del Cliente" id="DNI" onkeypress="return solonumero(event);" required="required" maxlength="8" name="DNI" class="form-control col-md-7 col-xs-12">

                    </div>
                    <div class="col-md-1 col-sm-1 col-xs-12">
                        <button type="submit" name="btnBuscar" id="btnBuscar" class="btn btn-info btn-md">Buscar</button>
                    </div>


                </div>
                <div class="form-group">
                    <label class="control-label col-md-1 col-sm-1 col-xs-12" for="last-name">
                        Nombres
                    </label>
                    <div class="col-md-4 col-sm-4 col-xs-12">
                        <input type="text" placeholder="Nombres" id="Nombres" disabled="disabled" class="form-control col-md-7 col-xs-12">
                    </div>
                    <label class="control-label col-md-2 col-sm-2 col-xs-12" for="first-name">
                        Teléfono
                    </label>
                    <div class="col-md-4 col-sm-4 col-xs-12">
                        <input type="text" placeholder="Telefono del Cliente" id="Telefono" name="Telefono" disabled="disabled" class="form-control col-md-7 col-xs-12">
                    </div>
                </div>
                <div class="form-group">
                    <label for="middle-name" class="control-label col-md-1 col-sm-1 col-xs-12">Tipo</label>
                    <div class="col-md-4 col-sm-4 col-xs-12">
                        <input type="text" placeholder="Tipo" id="Descripcion" name="Descripcion" disabled="disabled" class="form-control col-md-7 col-xs-12">
                    </div>

                    <label class="control-label col-md-3 col-sm-3 col-xs-12">Fecha Registro</label>
                    <div class="col-md-3 col-sm-3 col-xs-12">
                        <input id="Fecha" placeholder="Fecha de Registro" disabled="disabled" class="form-control col-md-7 col-xs-12" type="text" name="Fecha">
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-md-1 col-sm-1 col-xs-12">Direccion</label>
                    <div class="col-md-5 col-sm-5 col-xs-12">
                        <input id="DireccionDestino" placeholder="Direccion del Cliente" class="form-control col-md-7 col-xs-12" type="text" name="DireccionDestino" disabled="disabled">
                    </div>
                    <label class="control-label col-md-2 col-sm-2 col-xs-12">Fecha Traslado</label>
                    <div class="col-md-3 col-sm-3 col-xs-12">
                        <input id="FechaTraslado" name="FechaTraslado" type="text" required="required" class="form-control has-feedback-left" placeholder="Fecha Traslado" aria-describedby="inputSuccess2Status">
                        <span class="fa fa-calendar-o form-control-feedback left" aria-hidden="true"></span>
                        <span id="inputSuccess2Status" class="sr-only">(success)</span>
                    </div>


                </div>

                <br />
                <h2>Datos del Pedido</h2>

                <div class="ln_solid"></div>
                <div class="dataTables_wrapper form-inline dt-bootstrap no-footer">
                    <div class="row">
                        <div class="col-sm-12">
                            <table id="datatable" class="table table-striped table-bordered dataTable no-footer" role="grid" aria-describedby="datatable_info">
                                <thead>
                                    <tr role="row">
                                        <th class="sorting_asc">Codigo</th>
                                        <th class="sorting_asc">Descripcion</th>
                                        <th class="sorting_asc">Unidad</th>
                                        <th class="sorting_asc">Cantidad</th>

                                    </tr>
                                </thead>
                                <tbody id="ordenes"></tbody>

                            </table>
                        </div>

                    </div>

                </div>



                <div class="form-group">
                    <div class="col-md-12 col-sm-12 col-xs-12" style="text-align:center">
                        <button type="submit" id="btnGuardar" name="btnGuardar" class="btn btn-primary btn-lg">Guardar</button>
                        <button type="submit" class="btn btn-success btn-lg">Imprimir</button>
                    </div>
                </div>
            </form>
        </div>

    </div>
</div>




<div id="output"></div>

<div id="overlay" class="web_dialog_overlay"></div>

<div id="dialog" class="web_dialog">
    <div class="modal-header">
        <button type="button" id="btnClose2" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Despachos Pendientes</h4>
    </div>

    <div class="modal-body">
        <div class="form-horizontal">

            <div class="table-responsive">
                <div class="dataTables_wrapper form-inline dt-bootstrap no-footer">
                    <div class="row">
                        <div class="col-sm-12">
                            <table id="tablependientes" style="width:100%" class="table table-striped table-bordered dataTable no-footer" role="grid" aria-describedby="datatable_info">
                                <thead>
                                    <tr role="row">
                                        <th class="sorting_asc">IdOrden</th>
                                        <th class="sorting_asc">TipoOrden</th>
                                        <th class="sorting_asc">Fecha</th>
                                        <th class="sorting_asc">Descripcion</th>
                                        <th class="sorting_asc">Monto</th>
                                        <th class="sorting_asc">Seleccion</th>
                                    </tr>
                                </thead>
                                <tbody id="ordenes"></tbody>

                            </table>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="btnBuscar2" name="btnBuscar2">Actualizar</button>
        <button type="button" id="btnClose" class="btn btn-default" data-dismiss="modal">Cerrar</button>
    </div>




</div>






<!-- jQuery -->
<!-- Select2 -->



<script type="text/javascript">
    function CargarProducto() {
        if (document.getElementById("Articulos").selectedIndex == 0) {
            $("#Cantidad").val("");
            $("#Precio").val("");
            $("#SubTotal").val("");
            $("#lblUnidad").text("");
            //LimpiarArticulo();
        }
        else {

            $.ajax({
                url: rootDir + "/GuiaDespacho/CargarProducto",
                type: "GET",
                contentType: "application/json; charset=utf-8",
                data: {
                    "IdArticulo": $('#Articulos').val(),
                },
                dataType: "json",
                success: function (data) {

                    if ($("#Cantidad").val() == "") {
                        $("#Cantidad").val(1);
                    }
                    var Cantidad = $("#Cantidad").val();

                    $("#Precio").val(parseFloat(data.Precio).toFixed(2));
                    $("#SubTotal").val(parseFloat(Cantidad * data.Precio).toFixed(2));
                    $("#lblUnidad").text(data.UnidadMedida);
                },
                error: function (result) {
                    alert("Error");
                }
            });
        }
    }
    function LimpiarProveedor() {
        $("#RUC").val("");
        $("#DireccionDestino").val("");
    }
    function LimpiarArticulo() {
        $("#Articulos").val("");
        $("#Articulos").trigger("change");
        $("#Cantidad").val("");
        $("#Precio").val("");
        $("#SubTotal").val("");
        $("#lblUnidad").text("");

    }
    function CargarProveedor() {
        if (document.getElementById("Proveedor").selectedIndex == 0) {
            LimpiarProveedor();
            LimpiarArticulo();

        } else {

            $.ajax({
                url: rootDir + "/OrdenCompra/CargarProveedor",
                type: "GET",
                contentType: "application/json; charset=utf-8",
                data: {
                    "IdProveedor": $('#Proveedor').val(),
                },
                dataType: "json",
                success: function (data) {
                    $("#RUC").val(data.RUC);
                    $("#DireccionDestino").val(data.Direccion);
                },
                error: function (result) {
                    alert("Error");
                }
            });
        }


    }
    function CalcularSubTotal() {

        var Cantidad = parseFloat($("#Cantidad").val());
        var Precio = parseFloat($("#Precio").val());
        $("#SubTotal").val((Cantidad * Precio).toFixed(2));
    }
    function onSucess() {
        alert('1');

    }
    function modificar() {
        e.preventDefault();

    }
</script>


<!-- Parsley -->
<script>



    var d = new Date();
    var mindate = d.getDate() + "/" + (d.getMonth() + 1) + "/" + d.getFullYear();


    function solonumero(e) {
        tecla = (document.all) ? e.keyCode : e.which;

        //Tecla de retroceso para borrar, siempre la permite
        if (tecla == 8) {
            return true;
        }

        // Patron de entrada, en este caso solo acepta numeros
        patron = /[0-9]/;
        tecla_final = String.fromCharCode(tecla);
        return patron.test(tecla_final);
    }

    $(document).ready(function () {

     

        $('#FechaTraslado').daterangepicker({
            singleDatePicker: true,
            singleClasses: "picker_1",
            minDate: mindate,
            locale: {
                format: 'DD/MM/YYYY'},
            autoUpdateInput: false},
        function (chosen_date) {
            $('#FechaTraslado').val(chosen_date.format('DD/MM/YYYY'));
        }
        );
        $('#FechaTraslado').val('');

        $('#datatable').dataTable(
         {
             "sDom": '<"hide"i>rt<"bottom"lp><"clear">',
             "columnDefs": [
          {
              "targets": [0],
              "visible": true,
              "searchable": false
          }

             ],
             "language": {
                 "sProcessing": "Procesando...",
                 "sLengthMenu": "Mostrar _MENU_ registros",
                 "sZeroRecords": "No se encontraron resultados",
                 "sEmptyTable": "Ningún dato disponible en esta tabla",
                 "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                 "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                 "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                 "sInfoPostFix": "",
                 "sSearch": "Buscar:",
                 "sUrl": "",
                 "sInfoThousands": ",",
                 "sLoadingRecords": "Cargando...",
                 "oPaginate": {
                     "sFirst": "Primero",
                     "sLast": "Último",
                     "sNext": "Siguiente",
                     "sPrevious": "Anterior"
                 },
                 "oAria": {
                     "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                     "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                 }
             }
         }
         );



        $('#tablependientes').dataTable(
      {
          "lengthMenu": [[5], [5]],
          "sDom": '<"hide"i>rt<"bottom"lp><"clear">',
          "columnDefs": [
       {
           "targets": [0],
           "visible": false,
           "searchable": false
       },
         {
             "targets": [1],
             "visible": false,
             "searchable": false
         },
         {
             "targets": [5],
             "className": 'link',
             "orderable": false,
             "data": null,
             "defaultContent": '<a>Seleccionar</a>'
         }

          ],
          "language": {
              "sProcessing": "Procesando...",
              "sLengthMenu": "Mostrar _MENU_ registros",
              "sZeroRecords": "No se encontraron resultados",
              "sEmptyTable": "Ningún dato disponible en esta tabla",
              "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
              "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
              "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
              "sInfoPostFix": "",
              "sSearch": "Buscar:",
              "sUrl": "",
              "sInfoThousands": ",",
              "sLoadingRecords": "Cargando...",
              "oPaginate": {
                  "sFirst": "Primero",
                  "sLast": "Último",
                  "sNext": "Siguiente",
                  "sPrevious": "Anterior"
              },
              "oAria": {
                  "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                  "sSortDescending": ": Activar para ordenar la columna de manera descendente"
              }
          }
      }
      );


        $('#tablependientes tbody').on('click', 'td.link', function (e) {
            e.preventDefault();
            var table = $('#tablependientes').DataTable();
            //console.log(this);
            var data = table.row(this).data();

            var IdOrden = data[0];
            var TipoOrden = data[1];
            // console.log(IdOrden);
            // console.log(TipoOrden);
            $.ajax({
                type: 'POST',
                url: rootDir + '/GuiaDespacho/CargarDetalle',
                data: {
                    "IdOrden": IdOrden,
                    "TipoOrden": TipoOrden
                },
                dataType: 'json',
                success: function (data) {
                    // console.log(data);
                    $("#Nombres").val(data.Nombres);
                    $("#Telefono").val(data.Telefono);
                    $("#Descripcion").val(data.Descripcion);
                    $("#DireccionDestino").val(data.Direccion);
                    $("#Fecha").val(parseJsonDate(data.Fecha));
                    var arti = data.Articulos;
                    //console.log(arti);
                    var articulos = $('#datatable').DataTable();
                    articulos.clear().draw();
                    $.each(arti, function (index, item) {


                        //console.log(item);

                        articulos.row.add([
                                item.IdArticulo,
                                item.Nombre,
                                item.UnidadMedida,
                                item.Cantidad.toFixed(2),
                        ]).draw();
                    });

                    $("#IdOrden").val(IdOrden);
                    $("#TipoOrden").val(TipoOrden);

                    //alert(data.success);
                    //alert('Hoja de ruta ' + varHojaRutaFormat + zeroPad(varIdHojaRuta, 4) + ' creado.');

                    //location.href = rootDir + "/OrdenCompra/Index"
                    HideDialog();

                },
                error: function () {
                    alert("Error al Cargar Datos del Despacho");
                }
            });

        });


        var edit;




        $('#btnAgregar').click(function (e) {
            e.preventDefault();
            var validar = true;
            if (document.getElementById("Articulos").selectedIndex == 0) {
                validar = false;
                alert('Seleccione un Articulo');
            }
            else if (document.getElementById("Cantidad").value == "") {
                validar = false;
                alert('Ingrese Cantidad');
            }
            else if (document.getElementById("Precio").value == "") {
                validar = false;
                alert('Ingrese Precio');
            }




            var t = $('#datatable').DataTable();
            var da = t.rows().data();
            var IdArticulo = $("#Articulos").val();

            //console.log($("#hfOperacion").val());

            if (validar == true) {

                //Editar
                if ($("#hfOperacion").val() == 2) {
                    //console.log(edit);
                    da.row(edit).data([IdArticulo,
                                 $("#Articulos option:selected").text(),
                                 $("#lblUnidad").text(),
                                 $('#Cantidad').val().toFixed(2),
                                 $('#Precio').val().toFixed(2),
                                 $('#SubTotal').val().toFixed(2)]).draw();

                    /* da.each(function (value, index) {
                         var id = value[0];
                         if (id == IdArticulo) {
                             console.log(this);
                             this.data([
                                     IdArticulo,
                                     $("#Articulos option:selected").text(),
                                 $("#lblUnidad").text(),
                                 $('#Cantidad').val(),
                                 $('#Costo').val(),
                                 $('#SubTotal').val()]).draw();
                         }
                     });*/

                    LimpiarArticulo();
                    $("#hfOperacion").val(1);
                    $("#btnAgregar").text("Agregar");
                } else {
                    var encontrado = false;
                    da.each(function (value, index) {
                        var id = value[0];
                        if (id == IdArticulo) {
                            encontrado = true;
                        }
                    });

                    //Insertar
                    if (encontrado == true) {
                        alert("El Item Seleccionado ya existe en la lista, cambie la cantidad.")
                        return;
                    }

                    var t = $('#datatable').DataTable();

                    t.row.add([
                         IdArticulo,
                        $("#Articulos option:selected").text(),
                            $("#lblUnidad").text(),
                            $('#Cantidad').val().toFixed(2),
                            $('#Precio').val().toFixed(2),
                            $('#SubTotal').val().toFixed(2)

                    ]).draw();

                    LimpiarArticulo();

                }

            }
        });



        $("#btnBuscar").click(function (e) {
            e.preventDefault();

            if ($("#DNI").val().length < 8) {
                alert("Ingrese un Número de DNI para Buscar");
                return;
            }

            var itemId;
            $.ajax({
                type: 'POST',
                url: rootDir + '/GuiaDespacho/Pendientes',
                data: {
                    "DNI": $("#DNI").val()
                },
                dataType: 'json',
                success: function (data) {
                    var t = $('#tablependientes').DataTable();
                    t.clear().draw();
                    $.each(data, function (index, item) {

                        /*      var $row = $('<tr><td style="display:none;">' + item.IdOrden + '</td><td style="display:none;">' + item.TipoOrden + '</td><td>' + parseJsonDate(item.Fecha) + '</td>' + '<td>' + item.Descripcion + '</td>' + '<td>'
                                  + item.Monto + '</td><td><a class="link">Seleccionar</a></td></tr>');
                              // console.log($row);
                              $("#tblPedidos").find("tbody").append($row);*/




                        t.row.add([
                            item.IdOrden,
                            item.TipoOrden,
                            parseJsonDate(item.Fecha),
                            item.Descripcion,
                            item.Monto.toFixed(2),

                        ]).draw();


                    });





                },
                error: function () { alert("error post"); }
            });


            ShowDialog(true);

        });



        $("#btnBuscar2").click(function (e) {
            e.preventDefault();
            var itemId;
            $.ajax({
                type: 'POST',
                url: rootDir+ '/GuiaDespacho/Pendientes',
                data: {
                    "DNI": $("#DNI").val()
                },
                dataType: 'json',
                success: function (data) {
                    var t = $('#tablependientes').DataTable();
                    t.clear().draw();
                    $.each(data, function (index, item) {

                        /*      var $row = $('<tr><td style="display:none;">' + item.IdOrden + '</td><td style="display:none;">' + item.TipoOrden + '</td><td>' + parseJsonDate(item.Fecha) + '</td>' + '<td>' + item.Descripcion + '</td>' + '<td>'
                                  + item.Monto + '</td><td><a class="link">Seleccionar</a></td></tr>');
                              // console.log($row);
                              $("#tblPedidos").find("tbody").append($row);*/



                        t.row.add([
                            item.IdOrden,
                            item.TipoOrden,
                            parseJsonDate(item.Fecha),
                            item.Descripcion,
                            item.Monto,

                        ]).draw();


                    });




                },
                error: function () { alert("error post"); }
            });




        });





        $('#frmdatos').submit(function (e) {
            var serializedForm = $(this).serialize();
            var t = $('#datatable').DataTable();

            if (!t.data().count()) {
                alert("No se ha registrado ningún Artículo");
                e.preventDefault();
                return;
            }


            console.log($('#IdOrden').val());
            console.log($('#TipoOrden').val());
            console.log($('#FechaTraslado').val());
            $.ajax({
                type: 'POST',
                url: rootDir + '/GuiaDespacho/GuardarGuia',
                data: {
                    "IdOrden": $('#IdOrden').val(),
                    "TipoOrden": $('#TipoOrden').val(),
                    "FechaTraslado": $('#FechaTraslado').val()
                },
                dataType: 'json',
                success: function (data) {


                    //alert(data.success);
                    //alert('Hoja de ruta ' + varHojaRutaFormat + zeroPad(varIdHojaRuta, 4) + ' creado.');

                    location.href = rootDir + "/GuiaDespacho/Index"

                },
                error: function () {
                    alert("Error al Guardar la Guia de Despacho");
                }
            });

            return false;

        });



        $(".select2_single").select2({
            allowClear: true
        });

        $('#select2_single').on("select2_single:selecting", function (e) {
            // what you would like to happen
        });




    });

    function ShowDialog(modal) {
        $("#overlay").show();
        $("#dialog").fadeIn(300);

        if (modal) {
            $("#overlay").unbind("click");
        }
        else {
            $("#overlay").click(function (e) {
                HideDialog();
            });
        }
    }

    function HideDialog() {
        $("#overlay").hide();
        $("#dialog").fadeOut(300);
    }

    $("#btnClose2").click(function (e) {
        HideDialog();
        e.preventDefault();
    });

    $("#btnClose").click(function (e) {
        HideDialog();
        e.preventDefault();
    });

    function parseJsonDate(jsonDate) {

        var fullDate = new Date(parseInt(jsonDate.substr(6)));
        var twoDigitMonth = (fullDate.getMonth() + 1) + ""; if (twoDigitMonth.length == 1) twoDigitMonth = "0" + twoDigitMonth;

        var twoDigitDate = fullDate.getDate() + ""; if (twoDigitDate.length == 1) twoDigitDate = "0" + twoDigitDate;
        var currentDate = twoDigitDate + "/" + twoDigitMonth + "/" + fullDate.getFullYear();

        return currentDate;
    };

    try {
        hljs.initHighlightingOnLoad();
    } catch (err) { }
</script>


<!-- /Parsley -->
